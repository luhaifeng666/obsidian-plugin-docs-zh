---
title: è£…é¥°
---
# è£…é¥°

è£…é¥°è®©æ‚¨æ§åˆ¶åœ¨[ç¼–è¾‘å™¨æ‰©å±•ä¸­](index.md)å¦‚ä½•ç»˜åˆ¶æˆ–è€…å±•ç¤ºå†…å®¹ã€‚å¦‚æœæ‚¨æ‰“ç®—é€šè¿‡åœ¨ç¼–è¾‘å™¨ä¸­æ·»åŠ ï¼Œæ›¿æ¢æˆ–è€…æ ·å¼åŒ–æ ‡ç­¾æ¥æ›´æ”¹å¤–è§‚ï¼Œæ‚¨å¾ˆå¯èƒ½éœ€è¦ä½¿ç”¨è£…é¥°ã€‚

é˜…è¯»å®Œæ­¤æŒ‡å—åï¼Œæ‚¨å°†ä¼šï¼š

- ç†è§£å¦‚ä½•ä½¿ç”¨è£…é¥°å»æ”¹å˜ç¼–è¾‘å™¨çš„å¤–è§‚ã€‚
- ç†è§£ä½¿ç”¨çŠ¶æ€å­—æ®µä»¥åŠè§†å›¾æ’ä»¶æä¾›è£…é¥°ä¹‹é—´çš„åŒºåˆ«ã€‚

:::tip
æœ¬é¡µæ—¨åœ¨æç‚¼ CodeMirror 6 å®˜æ–¹ä¸º Obsidian æ’ä»¶å¼€å‘è€…ä»¬æ‰€æä¾›æ–‡æ¡£çš„ç²¾åéƒ¨åˆ†ã€‚æƒ³è¦è·å–æ›´å¤šå…³äºçŠ¶æ€å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·æŸ¥é˜… [Decorating the Document](https://codemirror.net/docs/guide/#decorating-the-document) æ­¤æ–‡æ¡£ã€‚
:::

## å…ˆå†³æ¡ä»¶

- åŸºæœ¬äº†è§£ [çŠ¶æ€å­—æ®µ](state-fields.md)ã€‚
- åŸºæœ¬äº†è§£ [è§†å›¾æ’ä»¶](view-plugins.md)ã€‚

## æ¦‚è§ˆ

ä¸ä½¿ç”¨è£…é¥°æ—¶ï¼Œæ–‡æ¡£å°†å‘ˆç°ä¸ºçº¯æ–‡æœ¬çš„å½¢å¼ã€‚ä¸€ç‚¹ä¹Ÿä¸æœ‰è¶£ã€‚ä½¿ç”¨è£…é¥°åï¼Œæ‚¨å°†æ”¹å˜æ–‡æ¡£çš„å±•ç¤ºå½¢å¼ï¼Œæ¯”å¦‚é«˜äº®æ–‡æœ¬æˆ–è€…æ·»åŠ è‡ªå®šä¹‰ HTML æ ‡ç­¾ï¼š

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç±»å‹çš„è£…é¥°ï¼š

- ä½¿ç”¨ [Mark decorations](https://codemirror.net/docs/ref/#view.Decoration%5Emark) ä¿®æ”¹ç°æœ‰å…ƒç´ çš„æ ·å¼ã€‚
- ä½¿ç”¨ [Widget decorations](https://codemirror.net/docs/ref/#view.Decoration%5Ewidget) åœ¨æ–‡æ¡£ä¸­æ’å…¥æ ‡ç­¾ã€‚
- ä½¿ç”¨ [Replace decorations](https://codemirror.net/docs/ref/#view.Decoration%5Ereplace) éšè—æˆ–ä½¿ç”¨å…¶ä»–æ ‡ç­¾æ›¿æ¢æ–‡æ¡£çš„éƒ¨åˆ†å†…å®¹ã€‚
- ä½¿ç”¨ [Line decorations](https://codemirror.net/docs/ref/#view.Decoration%5Eline) ä»…ä¸ºçº¿æ·»åŠ æ ·å¼ã€‚

è¦æƒ³ä½¿ç”¨è£…é¥°ï¼Œæ‚¨éœ€è¦åœ¨ç¼–è¾‘å™¨æ‰©å±•å†…åˆ›å»ºä»–ä»¬ï¼Œå¹¶å°†æ‰©å±•ç¨‹åº __æä¾›__ ç»™ç¼–è¾‘å™¨ã€‚æ‚¨æœ‰ä¸¤ç§å°†è£…é¥°æä¾›ç»™ç¼–è¾‘å™¨çš„æ–¹å¼ï¼Œ__ç›´æ¥__ ä½¿ç”¨[çŠ¶æ€å­—æ®µ](state-fields.md) æˆ–è€… __é—´æ¥__ ä½¿ç”¨[è§†å›¾æ’ä»¶](view-plugins.md)ã€‚

## ä½•æ—¶ä½¿ç”¨è§†å›¾æ’ä»¶æˆ–è€…çŠ¶æ€å­—æ®µ

è§†å›¾æ’ä»¶ä»¥åŠçŠ¶æ€å­—æ®µéƒ½å¯ä»¥ä¸ºç¼–è¾‘å™¨æä¾›è£…é¥°ï¼Œä½†æ˜¯ä»–ä»¬ä¹‹é—´æœ‰äº›åŒºåˆ«ï¼š

- å¦‚æœæ‚¨å¯ä»¥æ ¹æ®è§†å›¾å†…éƒ¨çš„å†…å®¹å†³å®šè£…é¥°ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨è§†å›¾æ’ä»¶ã€‚
- å¦‚æœæ‚¨éœ€è¦åœ¨è§†å›¾å¤–éƒ¨ç®¡ç†è£…é¥°ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨çŠ¶æ€å­—æ®µã€‚
- å¦‚æœæ‚¨æƒ³åšå‡ºå¯èƒ½æ”¹å˜è§†å›¾å†…å®¹çš„ä¿®æ”¹ï¼Œæ¯”å¦‚æ·»åŠ åˆ†å‰²çº¿ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨çŠ¶æ€å­—æ®µã€‚

å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€ç§æ–¹æ³•æ¥å®ç°æ‚¨çš„æ‰©å±•, é‚£ä¹ˆè§†å›¾æ’ä»¶å¾€å¾€èƒ½å¸¦æ¥æ›´å¥½çš„æ€§èƒ½ã€‚æ¯”å¦‚ï¼Œè¯•æƒ³ä¸‹æ‚¨æ‰“ç®—å®ç°ä¸€ä¸ªç”¨æ¥æ£€æŸ¥æ–‡æ¡£æ‹¼å†™çš„ç¼–è¾‘å™¨æ‰©å±•ã€‚

ä¸€ç§æ–¹æ³•æ˜¯å°†æ•´ä¸ªæ–‡æ¡£ä¼ é€’ç»™å¤–éƒ¨æ‹¼å†™æ£€æŸ¥å™¨ï¼Œç„¶åè¿”å›é”™è¯¯åˆ—è¡¨ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œä¸ç®¡å½“å‰è§†å£ä¸­æœ‰ä»€ä¹ˆï¼Œæ‚¨éœ€è¦å°†æ¯æ¡é”™è¯¯æ˜ å°„åˆ°è£…é¥°ï¼Œå¹¶ä½¿ç”¨çŠ¶æ€å­—æ®µæ¥ç®¡ç†è£…é¥°ã€‚

å¦ä¸€ç§æ–¹å¼æ˜¯ä»…ä»…åªæ£€æŸ¥å±•ç¤ºåœ¨è§†å£ä¸­çš„å†…å®¹ã€‚åœ¨ç”¨æˆ·æ»šåŠ¨æµè§ˆæ–‡æ¡£æ—¶ï¼Œæ”¹æ‰©å±•éœ€è¦ä¸æ–­åœ°æ‰§è¡Œæ‹¼å†™æ£€æŸ¥ï¼Œä½†æ‚¨å¯ä»¥æ‹¼å†™æ£€æŸ¥åŒ…å«æ•°ç™¾ä¸‡è¡Œæ–‡æœ¬çš„æ–‡æ¡£ã€‚

![State field vs. view plugin](/images/img/decorations.svg)

## æä¾›è£…é¥°

æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨æƒ³æ„å»ºä¸€ä¸ªç¼–è¾‘å™¨æ‰©å±•ï¼Œç”¨è¡¨æƒ…ç¬¦å·æ›¿æ¢é¡¹ç›®ç¬¦å·åˆ—è¡¨é¡¹ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨è§†å›¾æ’ä»¶æˆ–çŠ¶æ€å­—æ®µæ¥å®Œæˆæ­¤æ“ä½œï¼Œä½†æœ‰ä¸€äº›åŒºåˆ«ã€‚ åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‚¨å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ç§ç±»å‹çš„æ‰©å±•æ¥å®ç°å®ƒã€‚

ä¸¤ç§å®ç°å…±äº«ç›¸åŒçš„æ ¸å¿ƒé€»è¾‘ï¼š

1. ä½¿ç”¨ [syntaxTree](https://codemirror.net/docs/ref/#language.syntaxTree) æŸ¥æ‰¾åˆ—è¡¨é¡¹ã€‚
2. å°†æ¯ä¸ªåˆ—è¡¨é¡¹çš„å‰å¯¼è¿å­—ç¬¦ `-` æ›¿æ¢ä¸ºå°éƒ¨ä»¶ã€‚

### å°éƒ¨ä»¶

å°éƒ¨ä»¶æ˜¯æ‚¨æ·»åŠ åˆ°ç¼–è¾‘å™¨ä¸­çš„è‡ªå®šä¹‰ HTML æ ‡ç­¾ã€‚æ‚¨å¯ä»¥åœ¨æ–‡æ¡£ä¸­çš„ç‰¹å®šä½ç½®æ’å…¥ä¸€ä¸ªå°éƒ¨ä»¶ï¼Œæˆ–è€…ç”¨ä¸€ä¸ªå°éƒ¨ä»¶æ›¿æ¢ä¸€æ®µå†…å®¹ã€‚

ä¸‹ä¾‹ä¸­å®šä¹‰äº†ä¸€ä¸ªè¿”å› `<span>ğŸ‘‰</span>` HTML æ ‡ç­¾çš„å°éƒ¨ä»¶ã€‚æ‚¨å°†åœ¨ç¨åä½¿ç”¨åˆ°å®ƒã€‚

```ts
import { EditorView, WidgetType } from "@codemirror/view";

export class EmojiWidget extends WidgetType {
  toDOM(view: EditorView): HTMLElement {
    const div = document.createElement("span");

    div.innerText = "ğŸ‘‰";

    return div;
  }
}
```

è¦æƒ³ä½¿ç”¨ emoji å°éƒ¨ä»¶æ›¿æ¢æ‚¨æ–‡æ¡£ä¸­çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨[æ›¿æ¢è£…é¥°](https://codemirror.net/docs/ref/#view.Decoration%5Ereplace)ã€‚

```ts
const decoration = Decoration.replace({
  widget: new EmojiWidget()
});
```

### çŠ¶æ€å­—æ®µ

æä¾›æ¥è‡ªçŠ¶æ€å­—æ®µçš„è£…é¥°ï¼š

1. ä½¿ç”¨ `DecorationSet` ç±»å‹[å®šä¹‰çŠ¶æ€å­—æ®µ](state-fields.md#defining-a-state-field)
2. å°† `provide` å±æ€§æ·»åŠ åˆ°çŠ¶æ€å­—æ®µä¸­ã€‚

```ts
provide(field: StateField<DecorationSet>): Extension {
  return EditorView.decorations.from(field);
},
```

```ts field.ts
import { syntaxTree } from "@codemirror/language";
import {
  Extension,
  RangeSetBuilder,
  StateField,
  Transaction,
} from "@codemirror/state";
import {
  Decoration,
  DecorationSet,
  EditorView,
  WidgetType,
} from "@codemirror/view";
import { EmojiWidget } from "emoji";

export const emojiListField = StateField.define<DecorationSet>({
  create(state): DecorationSet {
    return Decoration.none;
  },
  update(oldState: DecorationSet, transaction: Transaction): DecorationSet {
    const builder = new RangeSetBuilder<Decoration>();

    syntaxTree(transaction.state).iterate({
      enter(node) {
        if (node.type.name.startsWith("list")) {
          // Position of the '-' or the '*'.
          const listCharFrom = node.from - 2;

          builder.add(
            listCharFrom,
            listCharFrom + 1,
            Decoration.replace({
              widget: new EmojiWidget(),
            })
          );
        }
      },
    });

    return builder.finish();
  },
  provide(field: StateField<DecorationSet>): Extension {
    return EditorView.decorations.from(field);
  },
});
```

### è§†å›¾æ’ä»¶

To manage your decorations using a view plugin:

ä½¿ç”¨è§†å›¾æ’ä»¶ç®¡ç†æ‚¨çš„è£…é¥°ï¼š

1. [åˆ›å»ºä¸€ä¸ªè§†å›¾æ’ä»¶](view-plugins.md#creating-a-view-plugin).
1. åœ¨æ‚¨çš„æ’ä»¶ä¸­æ·»åŠ  `DecorationSet` æˆå‘˜å±æ€§ã€‚
1. åœ¨ `constructor()` æ–¹æ³•ä¸­åˆå§‹åŒ–è£…é¥°ã€‚
1. åœ¨ `update()` ä¸­é‡æ–°æ„å»ºè£…é¥°ã€‚

ä»¥ä¸‹ç¤ºä¾‹ä»…åœ¨åŸºç¡€æ–‡æ¡£æˆ–è§†å£æ›´æ”¹æ—¶é‡å»ºè£…é¥°ã€‚ä»¥ä¸‹ç¤ºä¾‹ä»…åœ¨åŸºç¡€æ–‡æ¡£æˆ–è§†å£æ›´æ”¹æ—¶é‡å»ºè£…é¥°ã€‚

```ts plugin.ts
import { syntaxTree } from "@codemirror/language";
import { RangeSetBuilder } from "@codemirror/state";
import {
  Decoration,
  DecorationSet,
  EditorView,
  PluginSpec,
  PluginValue,
  ViewPlugin,
  ViewUpdate,
  WidgetType,
} from "@codemirror/view";
import { EmojiWidget } from "emoji";

class EmojiListPlugin implements PluginValue {
  decorations: DecorationSet;

  constructor(view: EditorView) {
    this.decorations = this.buildDecorations(view);
  }

  update(update: ViewUpdate) {
    if (update.docChanged || update.viewportChanged) {
      this.decorations = this.buildDecorations(update.view);
    }
  }

  destroy() {}

  buildDecorations(view: EditorView): DecorationSet {
    const builder = new RangeSetBuilder<Decoration>();

    for (let { from, to } of view.visibleRanges) {
      syntaxTree(view.state).iterate({
        from,
        to,
        enter(node) {
          if (node.type.name.startsWith("list")) {
            // Position of the '-' or the '*'.
            const listCharFrom = node.from - 2;

            builder.add(
              listCharFrom,
              listCharFrom + 1,
              Decoration.replace({
                widget: new EmojiWidget(),
              })
            );
          }
        },
      });
    }

    return builder.finish();
  }
}

const pluginSpec: PluginSpec<EmojiListPlugin> = {
  decorations: (value: EmojiListPlugin) => value.decorations,
};

export const emojiListPlugin = ViewPlugin.fromClass(
  EmojiListPlugin,
  pluginSpec
);
```

`buildDecorations()` æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œå®ƒåŸºäºç¼–è¾‘å™¨è§†å›¾æ„å»ºä¸€æ•´å¥—è£…é¥°ã€‚

æ³¨æ„ä¼ å…¥ `ViewPlugin.fromClass()` çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚`PluginSpec` ä¸­çš„ `decorations` å±æ€§æŒ‡å®šè§†å›¾æ’ä»¶å¦‚ä½•å‘ç¼–è¾‘å™¨æä¾›è£…é¥°ã€‚

ç”±äºè§†å›¾æ’ä»¶çŸ¥é“ä»€ä¹ˆå¯¹ç”¨æˆ·å¯è§ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨ `view.visibleRanges` æ¥é™åˆ¶è¦è®¿é—®çš„è¯­æ³•æ ‘çš„å“ªäº›éƒ¨åˆ†ã€‚
